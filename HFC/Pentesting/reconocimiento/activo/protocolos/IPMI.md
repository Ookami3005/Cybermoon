[<- Índice](../../../Pentesting.md)
# Intelligent Platform Management Interface

> ***IPMI*** (*Intelligent Platform Management Interface*) es un conjunto de especificaciones estándar para la administración del *hardware*, comúnmente utilizadas para monitoreo y supervisión del sistema a bajo nivel, incluso si este se encuentra apagado o atorado de alguna forma.

Actua como un **subsistema** independiente del *BIOS*, *CPU*, *Firmware* y sistema operativo del dispositivo, que funciona gracias a que requiere una fuente de poder y conexión *LAN* propias para que funcione correctamente.

Opera a traves de una conexión de red directa al *hardware* del sistema, sin requerir ningun acceso al sistema operativo.

En general, permite monitorear una gran cantidad de aspectos, como temperatura, voltaje, estado de los ventiladores, energía suministrada, *logs* del *hardware*, alertas *SNMP*, etc.
También permite realizar actualizaciones de forma remota al sistema sin necesitar acceso físico al equipo.

**IPMI** se utiliza principalmente de 3 maneras distintas:

- Antes de que el sistema operativo arranque para modificar ajustes en la *BIOS*
- Cuando el equipo esta completamente apagado
- Para acceder al equipo si este falla o se encuentra en un estado no-responsivo

Inicialmente, el protocolo *IPMI* fue publicado por *Intel* en 1998 y actualmente es soportado por más de 200 manufactureras como *Cisco*, *Dell*, *HP*, *Supermicro*, *Intel*, etc.

Los equipos que utilizan *IPMI 2.0* incluso pueden ser administrador via *serial* a través de una red *LAN*, permitiendo a los administradores interactuar con una consola serial.

Más detalladamente, para su funcionamiento *IPMI* requiere:

- ***BMC*** (*Baseboard Management Controller*): Un micro-controlador esencial para *IPMI*.
- ***ICMB*** (*Intelligent Chassis Management Bus*): Una interfaz que permita comunicaciones entre distintos chasís.
- ***IPMB*** (*Intelligent Platform Management Bus*): Extiende la **BMC**.
- ***Memoria IPMI***: Almacena recursos como *log*s de eventos y demás datos del sistema.
- ***Interfaces de comunicación***: Interfaces locales, seriales y *LAN* del sistema, compatibles con **ICMB** y buses de administración **PCI**.

## Configuración

> El servicio se aloja típicamente en el puerto **623** *UDP* y no posee archivos de configuración como tal.

En lo que si varía este servicio, es en las *BMC* utilizadas que no son más que pequeños sistemas operativos *ARM* corriendo alguna versión de *Linux* y conectados directamente sobre la placa madre.

Entre los **BMC** más frecuentes en procedimientos de auditoría son:

- *HP iLO*
- *Dell iDRAC*
- *Supermicro IPMI*

El acceso a un *BMC* muchas veces implica el control total de la placa madre del equipo, y nos vuelve capaces de monitorear, apagar, reiniciar e incluso reinstalar el sistema operativo principal del equipo.

#### Configuraciones peligrosas

Uno de los principales riesgos de *IPMI* son las credenciales por defecto en **BMC**'s bien conocidas, por ejemplo, para los **BMC** más comunes:

| BMC               | Usuario         | Contraseña                                                    |
| ----------------- | --------------- | ------------------------------------------------------------- |
| *Dell iDRAC*      | root            | calvin                                                        |
| *HP iLO*          | *Administrator* | (8 caracteres aleatorios entre letras en mayuscula y números) |
| *Supermicro IPMI* | ADMIN           | ADMIN                                                         |

SIn embargo, incluso si estas credenciales por defecto no funcionan para acceder al *BMC*, existe una vulnerabilidad común en el subprotocolo *RAKP* de *IPMI 2.0* donde, antes de que tome lugar la autenticación, el servidor envía un *hash* SHA1 o MD5 con sal de la contraseña del usuario.

Podemos aprovecharnos de esto para intentar *crackear* el hash con otras herramientas para intentar obtener la contraseña en texto claro.
Por ejemplo, una opción es `hashcat` en el modo `7300` y algún buen diccionario, o en caso de *HP iLO* donde la contraseña es aleatoria, podemos hacer uso de las máscaras para generar las cadenas:

```bash
# HP iLO
hashcat -m 7300 ipmi.txt -a 3 ?1?1?1?1?1?1?1?1 -1 ?d?u
```

# Enumeración

#### Nmap

> **Nmap** brinda un valioso *script* `ipmi-version` para identificar los detalles básicos del servicio como versión, políticas de usuario, políticas de contraseña, etc.

```bash
sudo nmap -sU --script ipmi-version -p 623 ilo.inlanfreight.local

# Starting Nmap 7.92 ( https://nmap.org ) at 2021-11-04 21:48 GMT
# Nmap scan report for ilo.inlanfreight.local (172.16.2.2)
# Host is up (0.00064s latency).
# 
# PORT    STATE SERVICE
# 623/udp open  asf-rmcp
# | ipmi-version:
# |   Version:
# |     IPMI-2.0
# |   UserAuth:
# |   PassAuth: auth_user, non_null_user
# |_  Level: 2.0
# MAC Address: 14:03:DC:674:18:6A (Hewlett Packard Enterprise)
# 
# Nmap done: 1 IP address (1 host up) scanned in 0.46 seconds
```

#### Metasploit

Alternativamente, *Metasploit* ofrece el modo auxiliar `ipmi_version` para enumerar de igual forma los detalles básicos del servicio:

```msfconsole
msf6 > search ipmi_version

Matching Modules
================

   0  auxiliary/scanner/ipmi/ipmi_version  . normal  No  IPMI Information Discovery


Interact with a module by name or index. For example info 0, use 0 or use auxiliary/scanner/ipmi/ipmi_version

msf6 > use 0
msf6 auxiliary(scanner/ipmi/ipmi_version) > set rhosts 10.129.97.68
rhosts => 10.129.97.68
msf6 auxiliary(scanner/ipmi/ipmi_version) > run
[*] Sending IPMI requests to 10.129.97.68->10.129.97.68 (1 hosts)
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```