[<- Índice](../../../Pentesting.md)
# Microsoft SQL

> ***MSSQL*** (*Microsoft SQL*) es otro sistema de administración de bases de datos relacionales desarrollado por *Microsoft* como un proyecto de código cerrado pensado principalmente para sistemas *Windows*.

Es una opción **popular** para administradores y desarrolladores de aplicaciones *.NET* ya que este sistema de bases de datos posee una gran compatibilidad y soporte con el *framework .NET*.

Aunque existen implementaciones de **MSSQL** para sistemas *Linux* y *macOS*, lo más común es que encuentres este servicio en objetivos *Windows*.

### Clientes MSSQL

> **MSSQL** posee su propia implementación oficial de un cliente para su sistema de bases de datos, [SQL Server Management Studio](https://learn.microsoft.com/en-us/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15) o **SSMS** por sus siglas.

Posee todas las funcionalidades esperadas de un cliente y más, además de la gran compatibilidad típica de un desarrollo oficialmente relacionado con el sistema.

Por lo mismo es comúnmente instalado y configurado por los administradores de bases de datos en cualesquiera equipos donde se espera un uso continuo del servicio.
Esto abre la posibilidad de encontrar este *software* configurado en algún equipo comprometido y que represente un acceso sencillo a las bases de datos.

![ssms.png](imagenes/ssms.png)

Claro, este no es el único cliente disponible para este servicio y con el tiempo han surgido otras opciones extraoficiales como:

- [`mssql-cli`](https://docs.microsoft.com/en-us/sql/tools/mssql-cli?view=sql-server-ver15)
- [SQL Server PowerShell](https://docs.microsoft.com/en-us/sql/powershell/sql-server-powershell?view=sql-server-ver15)
- [HeidiSQL](https://www.heidisql.com/)
- [SQLPro]()
- [Impacket - MSSQL client](https://github.com/fortra/impacket/blob/master/examples/mssqlclient.py)

Entre estas, sin duda destaca el cliente de **Impacket** (`mssqlclient.py`) por su alta disponibilidad en cualquier entorno *Linux* y por su funcionalidad sencilla pero útil.

### Bases de datos MSSQL

Los **servidores** *MSSQL* tienen bases de datos preconfiguradas para cualquier instalación que contienen información básica y necesaria como la estructura de las otras bases de datos configuradas por administradores.

Un repaso de las más importantes es:

| Base de datos preconfigurada | Descripción                                                                                                                 |
| ---------------------------- | --------------------------------------------------------------------------------------------------------------------------- |
| **master**                   | Almacena toda la información del servidor *MYSQL*.                                                                          |
| **model**                    | Plantilla para la creación de bases de datos, cualquier cambio en esta se refleja en bases de datos creadas posteriormente. |
| **msdb**                     | En esta se almacenan todas las tareas programadas y alertas del servidor.                                                   |
| **tempdb**                   | Almacena objetos e información temporal.                                                                                    |
| **resource**                 | Es una base de datos únicamente de lectura y contiene todos los objetos necesarios para el funcionamiento del servidor.     |

## Configuración

> En una nueva instalación de *MSSQL*, el servicio corre típicamente bajo el usuario `SERVICE\MSSQLSERVER`, posee un mecanismo de autenticación estándar denominado **Windows Authentication** y, por defecto, no forza la encriptación en las conexiones.

**Windows Authentication** implica que la autenticación se redirige al sistema operativo *Windows* del servidor, es decir, que éste utilizará los mecanismos tradicionales como la base de datos *SAM* o su controlador de dominio (en caso de *Active Directory*) para autenticar al usuario que solicite interactuar con el servidor *MSSQL*.

### Configuraciones peligrosas

Al igual que *MySQL*, la configuración de un sistema de bases de datos es una tarea extensa, compleja y variada.
Hay muchisimos ajustes que podrían malconfigurarse y representar una vulnerabilidad para el servidor, demasiados para repasarlos unoi por uno, pero podríamos aprovecharnos de aspectos como:

- Clientes *MSSQL* que se conectan al servidor sin encriptación, tal vez podríamos interceptar algunas credenciales.
- El uso de certificados **autofirmados** para la encriptación, ya que son fácilmente suplantables.
- El uso de **Named pipes**, un mecanismo de comunicación interprocesos alternativo a conexiones *TCP/IP*, que podrían estar malconfigurados.
- Credenciales débiles o credenciales por defecto.

Recordemos que muchas configuraciones de servidores se realizan bajo presión y con prisa, es fácil cometer errores, por lo que siempre es buena idea ponerse en los pies de un administrador para intentar entender que se pudo haber hecho mal.

# Enumeración