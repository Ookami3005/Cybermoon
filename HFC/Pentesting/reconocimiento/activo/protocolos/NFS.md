[<- Índice](../../../Pentesting.md)
# Network File System

> ***NFS*** (*Network File System*) es otro protocolo de aplicación más con el mismo objetivo que *SMB*, permitir el acceso a sistemas de archivos a través de la red como si fueran locales. Sin embargo, *NFS* se desarrollo como un protocolo completamente distinto, lo que lo hace incompatible de primeras con servidores *SMB*.

*NFS* se ha vuelto un estándar en el *Internet* para la gestión de procesos remotos en sistemas distribuidos, y algunas características importantes de sus versiones son:

| Versión | Características                                                                                                                                                                     |
| ------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| *NFSv2* | Aunque viejo, soporta la mayoría de los sistemas y opera completamente sobre el protocolo *UDP*.                                                                                    |
| *NFSv3* | Tiene más funcionalidades, como flexibilidad en el tamaño de los archivos, un mejor reporte de errores y más estabilidad, pero no es completamente compatible con clientes *NFSv2*. |
| *NFSv4* | La versión más moderna, incluye compatibilidad con *Kerberos*, manejo de *Firewalls*, soporta *ACL's* y ofrece muchas mejoras de rendicimiento y seguridad.                         |

Otra ventaja significativa de *NFSv4* consiste en que, por defecto, únicamente corre el servicio sobre el puerto **2049** ya sea *TCP* o *UDP*.

*NFS* se basa principalmente en el protocolo ***ONC-RPC/SUN-RPC*** (*Open Network Computing Remote Procedure Call*), expuesto en el puerto **111** ya sea *TCP/UDP*, que utiliza ***Representación Externa de Datos*** (*XDR* por sus siglas en inglés) para el intercambio de datos entre sistemas independientes.

A pesar de la modernidad de *NFS*, este no tiene formalmente un mecanismo de **autenticación** ni de **autorización**. Cualquiera puede interactuar con el servicio y es el servidor el que se encarga de traducir la información de usuario del cliente al formato del **sistema de archivos** del servidor, intentando definir su autorización lo más preciso posible, lo que varía mucho dada su configuración.

Una de las principales ***formas de autorización***, en sistemas *UNIX*, son las identificaciones *UID/GID* y los permisos de los grupos. Claro, este mecanismo no es nada preciso pues los *UID/GID* pueden variar completamente y el servidor no tiene forma de hacer más comparaciones.

Por esto mismo, ==*NFS* la autorización por UID/GID únicamente se utiliza en redes privadas y de confianza==.

## Configuración

> *NFS* no es muy dificil de configurar, pues no tiene tantas opciones como *FTP* o *SMB*. Su archivo de configuración es `/etc/exports` que contiene una tabla de los directorios locales que se harán accesibles a los clientes.

Algunas opciones configurables para *NFS* son:

| Opción             | Descripción                                                                                                                                                                             |
| ------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `rw`               | Se permite la lectura y escritura de archivos                                                                                                                                           |
| `ro`               | Unicamente se permite la lectura de archivos                                                                                                                                            |
| `sync`             | La transferencia de datos es sincrónica pero un poco más lenta.                                                                                                                         |
| `async`            | La transferencia de datos es asincrónica                                                                                                                                                |
| `secure`           | No se permite utilizar puertos arriba de 1024                                                                                                                                           |
| `insecure`         | Si se permiten puertos arriba de 1024                                                                                                                                                   |
| `no_subtree_check` | Esta opción deshabilita la revisión de subdirectorios                                                                                                                                   |
| `root_squash`      | Los permisos de archivos pertenecientes a *root* (*UID/GID* 0) se asignan automáticamente al *UID/GID* de un usuario `anonymous` para prevenir la creación de archivos de superusuario. |

Este archivo de configuración es muy corto y podría verse algo así:

```txt
# /etc/exports: the access control list for filesystems which may be exported
#               to NFS clients.  See exports(5).
#
# Example for NFSv2 and NFSv3:
# /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)
#
# Example for NFSv4:
# /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)
# /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)
```

### Opciones peligrosas

> Algunas opciones que pueden representar un riesgo para la compañia son:

| Opción           | Descripción                                                                                                                                              |
| ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `rw`             | Se permite la lectura y escritura de archivos                                                                                                            |
| `insecure`       | Se permiten puertos arriba de 1024                                                                                                                       |
| `no_root_squash` | Todos los archivos creados por un usuario `root` se matienen con el *UID/GID* 0.                                                                         |
| `nohide`         | Si se monta un segundo sistema de archivos dentro de un sistema de archivos montado, este mantiene las reglas de su configuración, y no las del primero. |

# Enumeración

### Nmap

> La enumeración de los puertos 111 y 2049 mediante *Nmap* es esencial, pues obtenemos información muy importante de *scripts* como `rpcinfo`, `nfs-showmount`, `nfs-ls` y `nfs-statfs`.

```bash
sudo nmap -p111,2049 -sV --script 'nfs*' 10.129.76.56
```

Esta información incluye las carpetas compartidas disponibles, los listados de estas y las configuraciones de puertos y carpetas.

### `rpcinfo`

> Otra forma de recabar información es utilizando la utilidad `rpcinfo`, que interactua con el servicio `rpcbind` para recopilar información acerca de los procesos ejecutandose a partir de *RPC*.

Para recabar información acerca de los puertos y servicios *NFS* presentes podemos utilizar la bandera `-p` que devuelve todos los procesos *NFS* del sistema, además de indicarle la dirección IP del objetivo.

```bash
rpcinfo -p 10.129.87.13

#     program vers proto   port  service
#     100000    4   tcp    111  portmapper
#     100000    3   tcp    111  portmapper
#     100000    2   tcp    111  portmapper
#     100000    4   udp    111  portmapper
#     100000    3   udp    111  portmapper
#     100000    2   udp    111  portmapper
#     100005    1   udp  51452  mountd
#     100005    1   tcp  46571  mountd
#     100005    2   udp  40580  mountd
#     100005    2   tcp  37505  mountd
#     100005    3   udp  54475  mountd
#     100005    3   tcp  52025  mountd
#     100003    3   tcp   2049  nfs
#     100003    4   tcp   2049  nfs
#     100227    3   tcp   2049  nfs_acl
#     100003    3   udp   2049  nfs
#     100227    3   udp   2049  nfs_acl
#     100021    1   udp  41385  nlockmgr
#     100021    3   udp  41385  nlockmgr
#     100021    4   udp  41385  nlockmgr
#     100021    1   tcp  40581  nlockmgr
#     100021    3   tcp  40581  nlockmgr
#     100021    4   tcp  40581  nlockmgr
```

La herramienta nos indica la identificación del proceso, el puerto asignado a cada proceso y el protocolo de transporte que utilizan.

Algunos de estos servicios clave de *NFS* son:

- `nfs`: Servicio principal de *NFS* con el que interactuamos para acceder al recurso compartido.
- `mountd`: Proceso de gestión de montajes *NFS*, realiza todos los procedimientos necesarios para que el montaje funcione
- `nlockmgr`: Proceso que gestiona el bloqueo de archivos
- `portmapper`: Asocia cada programa *RPC* con su puerto.

### `showmount`

> Una vez que reconocemos la presencia del servico principal *NFS*, podemos listar las carpetas compartidas disponibles mediante `showmount` de la siguiente manera:

```bash
showmount -e 10.129.14.128

# Export list for 10.129.14.128:
# /mnt/nfs 10.129.14.0/24
```

### Montando la carpeta *NFS*

Una vez que conocemos la carpeta compartida, podemos montarla en algun directorio **vacío** de nuestro sistema con apoyo de la utilidad `mount` de la siguiente manera:

```bash
mkdir /tmp/share
sudo mount -t nfs 10.129.14.128:/mnt/nfs /tmp/share -o nolock
cd /tmp/share
tree

# .
# └── mnt
#     └── nfs
#         ├── id_rsa
#         ├── id_rsa.pub
#         └── nfs.share
# 
# 2 directories, 3 files
```

Se utiliza la opción `-t` para indicar que deseamos utilizar el protocolo `nfs` y la opción `-o nolock` para optimizar el montado de la carpeta.

Una vez montada, ya podemos examinar el contenido como si se tratara de archivos locales.

# Enlaces

[<- SMB](SMB.md) | [DNS ->](DNS.md)