[<- Índice](../../../Pentesting.md)
# File Transfer Protocol

> ***FTP*** (*File Transfer Protocol*) es uno de los protocolos de aplicación más viejos en el *Internet*, que funciona a través del protocolo *TCP/IP*. Este protocolo es también soportado por navegadores *web* y clientes de correo, de modo que podamos interacrtuar con servicios de este protocolo mediante ellos.

Su funcionalidad principal es la de **descargar** y/o **cargar** archivos en el servidor, de modo que establecemos una comunicación *TCP* en el puerto por defecto (21), donde podemos indicar distintos comandos para interactuar con el servicio.

Una vez que se indica una transferencia de archivos, el cliente y el servidor establecen una segunda conexión a través del puerto 20, exclusivamente para la transferencia de datos.

Hoy en día, *FTP* posee un modo **activo** y uno **pasivo**.
El **activo**, para la transferencia de archivos es el **servidor** el que se conecta a un puerto del cliente para la transmisión del archivo.
Mientras que el **pasivo**, es el opuesto, donde el **cliente** es el que se conecta a un puerto del servidor para recibir el archivo. Este modo, por ejemplo, permite que equipos protegidos por *Firewall*, que bloquean las conexiones externas, puedan recibir el archivo sin problema, pues son ellos quienes inician la conexión.

Además *FTP* maneja una variedad de **codigos de respuesta** (similar a *HTTP*) para indicar detalladamente el resultado de los comandos ejecutados.
Muchos comandos *FTP*, son comandos similares a terminales *UNIX*, con otros tantos típicos unicamente de este protocolo.

#### Comandos

> Algunos de los comandos más útiles son:

- `ls`: Lista los contenidos de la carpeta actual.
- `cd <dir>`: Se ubica en el directorio específicado.
- `pwd`: Indica el directorio de trabajo actual.
- `get <archivo>`: Descarga el archivo del servidor.
- `put <archivo>`: Sube un archivo del directorio **local** (de nuestra computadora) al servidor.
- `mget <patron>`: Descarga todos los archivos que coincidan con el patron *UNIX* (por ejemplo, `*.txt`, `codigo*.py`, etc)
- `mput <patron>`: Sube todos los archivos del directorio **local** de trabajo que coincidan con el patrón.
- `binary`: Cambia el modo de tranmisión a binario (para aquellos archivos que no sean de texto, como fotos, ejecutables y demás).
- `ascii`: Cambia el modo de tranmisión a *ASCII* exclusivamente para archivos de texto.
- `syst`: Imprime información del sistema operativo del servidor.
- `bye/quit`: Termina la conexión

#### Códigos de respuesta

- `1xx`: **Respuestas preliminarmente positivas**, usualmente indican que el comando fue aceptado y esta en **proceso** de iniciar.
- `2xx`: **Respuestas positivas**, indican que la ejecución del comando ha concluido satisfactoriamente.
- `3xx`: **Respuestas intermedias positivas**, indican que el comando fue aceptado y comenzo su ejecución pero que se encuentra a la espera, posiblemente de más información o de otro comando.
- `4xx`: **Respuestas negativas temporales**, indican que el comando fallo y no se ejecuto, pero por una causa posiblemente temporal, por lo que es recomendable verificar el comando y volverlo a intentar.
- `5xx`: **Respuestas negativas permanentes**, indican que el comando ejecutado fallo por una causa específica y permanente, por lo que no funcionaria aunque se vuelva a intentar.

---

Usualmente, requerimos credenciales para autenticarnos en un servidor *FTP* pero puede ser el caso que se permitan **inicios de sesión anónimos**, donde podemos autenticarnos convencionalmente con el usuario y la contraseña `anonymous`.
El hecho de permitir este inicisio de sesión o aún peor, permitir que modifique y suba archivos, representa un gran riesgo de seguridad.

Además, este protocolo sostiene la comunicación en **texto claro** a comparación con protocolos cifrados como *HTTPS*, por lo que es posible interceptar estas comunicaciones y visualizar la información sin problemas.

### TFTP

> ***TFTP*** (*Trivial File Transfer Protocol*) es una ==versión simplificada== de *FTP* encargado de cumplir también con la transferencia de archivos entre clientes y el servidor. Sin embargo, **no** posee autenticación de usuarios ni otras características más de *FTP*, y su comunicación se basa en el protocolo de transporte *UDP*, en lugar de *TCP*.

Esta falta de seguridad causa que, si se utiliza, *TFTP* únicamente se aloje en redes privadas y protegidas, con archivos y directorios compartidos por **todos** los usuarios.

Además, *TFTP* no tiene una función de listado de directorio, entonces los archivos se solicitan directamente con algún conocimiento previo de su existencia.

Algunos comandos de *TFTP* son:

- `connect`: Para definir el servidor y opcionalmente el puerto para realizar las transferencias de archivos.
- `get`: Descargar un archivo del servidor.
- `put`: Subir un archivo al servidor
- `status`: Imprime las configuraciones actuales de la conexión, como el modo de transferencia, el estado de la conexión, los tiempos de espera, etc.
- `verbose`: Activa el modo verboso para imprimir información adicional de los procesos.
- `quit`: Cierra la conexión.

## vsFTPd

> Uno de los servidores más utilizados por distribuciones *Linux* es ***vsFTPd*** (*Very Secure FTP Daemon*), ya que es gratuito y de **código libre**. Por esto mismo, es importante estudiar y enteder algunas de sus configuraciones más importantes.

El archivo de configuración de *vsFTPd* reside en `/etc/vsftpd.conf` y en el encontramos o definimos opciones como:

| Opción                     | Descripción                                                                                                                              |
| -------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| `listen=YES`               | Indica que el servidor se ponga a la escucha para conexiones IPv4.                                                                       |
| `listen_ipv6=NO`           | Lo mismo, pero para conexiones IPv6.                                                                                                     |
| `anonymous_enable=NO`      | Permite o no el acceso por usuarios anónimos (`anonymous`)                                                                               |
| `local_enable=YES`         | Permite o no el acceso a usuarios locales                                                                                                |
| `xferlog_enable=YES`       | Activa o no el registro de *logs* sobre descargas y cargas de archivos.                                                                  |
| `connect_from_port_20=YES` | Indica que el puerto de transferencia de archivos sea el 20 o no.                                                                        |
| `ssl_enable=NO`            | Permite establecer la encriptación de la comunicación similar a *FTPS*, indicando un certificado y una llave privada con otras opciones. |

Además, también existe el archivo `/etc/ftpusers` que funciona como una *blacklist* de usuarios a los que no se permitira que se autentiquen en el servicio, aunque efectivamente existan en el sistema.

```bash
cat /etc/ftpusers

# # Users that are not allowed to login via ftp
# root
# bin
# daemon
# adm
# lp
# sync
# shutdown
# halt
# mail
# news
# uucp
# operator
# games
# nobody
```

### Configuraciones peligrosas

> Algunas de las opciones, relacionadas a seguridad, más importantes de *vsFTPd* son las siguientes:

#### Sesiones anónimas

| Opción                         | Descripción                                                                                               |
| ------------------------------ | --------------------------------------------------------------------------------------------------------- |
| `anonymous_enable=YES`         | Se permiten accesos anónimos.                                                                             |
| `anon_upload_enable=YES`       | Se permite al usuario anónimo subir archivos al servidor.                                                 |
| `anon_mkdir_write_enable=YES`  | Se permite al usuario anónimo crear nuevos directorios.                                                   |
| `no_anon_password=YES`         | El usuario anónimo no requiere contraseña.                                                                |
| `anon_root=/home/username/ftp` | Se define el directorio raíz del usuario anónimo                                                          |
| `write_enable=YES`             | Se permite la modificación de archivos en el servidor globalmente, como subir, borrar o mover un archivo. |
 De ser el caso, podríamos conectarnos con nuestro cliente *FTP* al servidor, en este caso la utilidad de terminal `ftp`, y acceder como el usuario  `anonymous` al servicio y de ser el caso, aprovecharnos de las funcionalidades que disponemos como la carga de archivos.

Este cliente, se utiliza indicandole la dirección *IP* del servidor al que deseamos conectarnos

```bash
ftp 10.24.35.67

# Connected to 10.129.14.136.
# 220 "Welcome to the HTB Academy vsFTP service."
# Name (10.129.14.136:cry0l1t3): anonymous
# Password: 

# 230 Login succesful
```

Una vez en el sistema, es útil recabar información sobre las configuraciones de conexión del sistema, por ejemplo, con el comando `status`

```ftp
ftp> status

Connected to 10.129.14.136.
No proxy connection.
Connecting using address family: any.
Mode: stream; Type: binary; Form: non-print; Structure: file
Verbose: on; Bell: off; Prompting: on; Globbing: on
Store unique: off; Receive unique: off
Case: off; CR stripping: on
Quote control characters: on
Ntrans: off
Nmap: off
Hash mark printing: off; Use of PORT cmds: on
Tick counter printing: off
```

Otra buena idea, es habilitar opciones que nos brinden más información al interactuar con el servidor, como lo son los comandos `debug`, para habilitar información de depuración, y `trace` para habilitar el seguimiento de paquetes.

#### Ocultamiento de identidades

> Otra configuración a tomar en cuenta, es el ***Ocultamiento de identidades***, una configuración de seguridad que oculta los nombres reales de los propietarios de los archivos, para evitar que se conozcan los nombres de usuario presentes en la computadora y su posible uso en posteriores ataques de fuerza bruta.

De estar activa esta configuración, todos los archivos del servidor apareceran como que su propietario es el usuario `ftp`.

```ftp
ftp> ls

---> TYPE A
200 Switching to ASCII mode.
ftp: setsockopt (ignored): Permission denied
---> PORT 10,10,14,4,223,101
200 PORT command successful. Consider using PASV.
---> LIST
150 Here comes the directory listing.
-rw-rw-r--    1 ftp     ftp      8138592 Sep 14 16:54 Calender.pptx
drwxrwxr-x    2 ftp     ftp         4096 Sep 14 17:03 Clients
drwxrwxr-x    2 ftp     ftp         4096 Sep 14 16:50 Documents
drwxrwxr-x    2 ftp     ftp         4096 Sep 14 16:50 Employees
-rw-rw-r--    1 ftp     ftp           41 Sep 14 16:45 Important Notes.txt
-rw-------    1 ftp     ftp            0 Sep 15 14:57 testupload.txt
226 Directory send OK.
```

#### Listado recursivo de archivos

> Si se encuentra habilitado, el **listado recursivo de archivos** es una manera rápida de enumerar los recursos del servidor. Pues se listan de manera recursiva los contenidos de todos los directorios presentes en el servidor.

```ftp
ftp> ls -R

---> PORT 10,10,14,4,222,149
200 PORT command successful. Consider using PASV.
---> LIST -R
150 Here comes the directory listing.
.:
-rw-rw-r--    1 ftp      ftp      8138592 Sep 14 16:54 Calender.pptx
drwxrwxr-x    2 ftp      ftp         4096 Sep 14 17:03 Clients
drwxrwxr-x    2 ftp      ftp         4096 Sep 14 16:50 Documents
drwxrwxr-x    2 ftp      ftp         4096 Sep 14 16:50 Employees
-rw-rw-r--    1 ftp      ftp           41 Sep 14 16:45 Important Notes.txt
-rw-------    1 ftp      ftp            0 Sep 15 14:57 testupload.txt

./Clients:
drwxrwxrwx    2 ftp      ftp          4096 Sep 16 18:00 Inlanefreight

./Clients/Inlanefreight:
-rw-r--r--    1 ftp      ftp         14211 Sep 16 18:00 appointments.xlsx
-rw-r--r--    1 ftp      ftp         37882 Sep 16 17:58 contract.docx
-rw-r--r--    1 ftp      ftp            89 Sep 16 17:58 meetings.txt
-rw-r--r--    1 ftp      ftp        483293 Sep 16 17:59 proposal.pptx

./Documents:
-rw-r--r--    1 ftp      ftp         23211 Sep 16 18:05 appointments-template.xlsx
-rw-r--r--    1 ftp      ftp         32521 Sep 16 18:05 contract-template.docx
-rw-r--r--    1 ftp      ftp        453312 Sep 16 18:05 contract-template.pdf

./Employees:
226 Directory send OK.
```

#### Descarga de archivos

> La **descarga** de archivos, es una de las principales funcionalidades del protocolo *FTP*, de modo que podamos examinar a fondo en nuestro sistema local los archivos dispuestos en el servidor. Esto permite una enumeración más exhaustiva donde muchas veces, identificamos información sensible y útil para nuestra causa.

Para descargar un archivo se puede utilizar el comando `get`, mientras que para descargar varios archivos en una sola ejecución se utiliza el comando `mget`.

```ftp
ftp> get ImportantNotes.txt

local: ImportantNotes.txt remote: ImportantNotes.txt
200 PORT command successful. Consider using PASV.
150 Opening BINARY mode data connection for ImportantNotes.txt (41 bytes).
226 Transfer complete.
41 bytes received in 0.00 secs (606.6525 kB/s)
```

Por ejemplo, con el siguiente comando obtendriamos todos los archivos presentes en la carpeta de Documents.

```shell-session
ftp> mget Documents/*
```

Sin embargo, esta última manera no descarga de manera recursiva todos los archivos presentes en el servidor, sino únicamente aquellos archivos específicamente alojados en Documents.

Para realizar una descarga recursiva de los archivos del servidor, podemos apoyarnos de `wget`, junto con algunas banderas para una funcionalidad óptima:

```bash
wget -m --no-passive-ftp 'ftp://anonymous:anonymous@10.12.23.46/'
```

Este comando, descargará en una carpeta con el nombre de la **dirección IP** (en este ejemplo, 10.12.23.46) todos los archivos del servidor de manera recursiva.

#### Carga de archivos

> En caso de contar con permisos para subir archivos al servidor, puede representar una vulnerabilidad enorme para la seguridad de la organización, dando lugar a vulnerabilidades como *Local File Inclusion* o hasta *Remote Code Execution* si se presta la situación.

Para subir un archivo se utiliza el comando `put`, mientras que para subir varios archivos se utiliza `mput`. Recordemos que se toman a partir del directorio de trabajo en el que estabamos al invocar el cliente `ftp`, a menos que le indiquemos una ruta absoluta.

```ftp
ftp> put testupload.txt 

local: testupload.txt remote: testupload.txt
---> PORT 10,10,14,4,184,33
200 PORT command successful. Consider using PASV.
---> STOR testupload.txt
150 Ok to send data.
226 Transfer complete.
```

## Enumeración

#### Nmap

> Tampoco debemos olvidar la enumeración por parte de escaneres y demás herramientas avanzadas como lo es *Nmap*. Para un análisis más avanzado e inmediato del comportamiento del servicio.

Para esto, tomemos en cuenta que *Nmap* cuenta con el *Nmap Script Engine* ([*NSE*](../nmap/Nmap-NSE.md)), que nos ofrece varios scripts específicos para *FTP*, que podemos listar con:

```bash
ls /usr/share/nmap/scripts/ftp-*

#	/usr/share/nmap/scripts/ftp-anon.nse
#	/usr/share/nmap/scripts/ftp-bounce.nse
#	/usr/share/nmap/scripts/ftp-brute.nse
#	/usr/share/nmap/scripts/ftp-libopie.nse
#	/usr/share/nmap/scripts/ftp-proftpd-backdoor.nse
#	/usr/share/nmap/scripts/ftp-syst.nse
#	/usr/share/nmap/scripts/ftp-vsftpd-backdoor.nse
#	/usr/share/nmap/scripts/ftp-vuln-cve2010-4221.nse
```

Algunos de estos, ya se ejecutan al realizar un escaneo con *scripts por defecto* con `-sC`, pero de requerir uno en específico podemos indicarlo con la bandera `--script`.

Por ejemplo, un escaneo por defecto nos podría brindar información como:

```nmap
PORT   STATE SERVICE VERSION
21/tcp open  ftp     vsftpd 2.0.8 or later
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
| -rwxrwxrwx    1 ftp      ftp       8138592 Sep 16 17:24 Calendar.pptx [NSE: writeable]
| drwxrwxrwx    4 ftp      ftp          4096 Sep 16 17:57 Clients [NSE: writeable]
| drwxrwxrwx    2 ftp      ftp          4096 Sep 16 18:05 Documents [NSE: writeable]
| drwxrwxrwx    2 ftp      ftp          4096 Sep 16 17:24 Employees [NSE: writeable]
| -rwxrwxrwx    1 ftp      ftp            41 Sep 16 17:24 Important Notes.txt [NSE: writeable]
|_-rwxrwxrwx    1 ftp      ftp             0 Sep 15 14:57 testupload.txt [NSE: writeable]
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to 10.10.14.4
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 2
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
```

# Enlaces

| [SMB ->](SMB.md)