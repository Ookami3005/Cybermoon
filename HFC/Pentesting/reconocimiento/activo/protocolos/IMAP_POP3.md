[<- Índice](../../../Pentesting.md)
# IMAP y POP3

> ***IMAP*** (*Internet Message Access Protocol*) y ***POP3*** (*Post Office Protocol*) son protocolos de aplicación con el objetivo de permitir el acceso a los correos electrónicos de un **servidor de correo**. Funcionan como una especie de **buzones de correo** que almacenan los correos recibidos y los presenta de una mejor manera al usuario y a las aplicaciones.

### POP3

***POP3*** es el protocolo más simple, el cual permite autenticar un usuario, listar los correos recibidos, inspeccionar el contenido de un correo, borrar correos y poco más. 

Este servicio sigue un modelo de comunicación **cliente-servidor** y se encuentra a la escucha en el puerto por defecto 110, en texto plano, mientras que su versión integrada con encriptación *TLS/SSL*, denominada **POP3S** se encuentra a la esucha en el puerto 995.

### IMAP

Por otra parte, ***IMAP*** es más avanzado que implementa muchas mejoras y funcionalidades nuevas en contraste con *POP3*, por ejemplo:

- Permite la organización de correos mediante **cajas** (*mailboxes*)
- Permite la sincronización de **buzones locales** con los correos en el servidor.
- Creación de copias locales
- Autenticación del usuario

***IMAP*** se encuentra a la escucha en el puerto 143, en texto claro, donde puede recibir una serie de comandos para interactuar con el cliente. Por otra parte, su versión con *TLS/SSL* ***IMAPS***, se encuentra a la escucha en el puerto 993. 

Los comandos en este protocolo son acompañados por un número al inicio que se considera su **identificador**.
Con estos **identificadores**, puede recibir una rápida sucesión de comandos sin esperar las respuestas del servidor, y una vez que este las procese, devolvera la respuesta junto con el **indicador** del comando correspondiente.

Además, su funcionalidad por **cajas** es lo que hoy en día permite la organización de los correos electrónicos según sean del buzon de entrada, borradores, enviados, spam, etc.

## Comandos

> Para este protocolo, tomaremos de ejemplo los servicios *Dovecot*, que posee una variante para *POP3* (`dovecot-pop3d`) y para *IMAP* (`dovecot-imapd`). Estos poseen una gran cantidad de opciones configurables que se dividen principalmente en **ajustes principales** y **ajustes particulares** para cada variante y que permiten regular el comportamiento del servidor según nuestras necesidades.

Es importante reconocer los comandos que cada protocolo admite para poder enumerar correctamente el servidor de manera manual, de modo que a continuación presentamos los más relevantes para cada protocolo.

Recordemos que en *IMAP* cada comando va acompañado de un número identificador, para estos ejemplos, utilizaremos siempre un 1.

#### IMAP

| Comando                         | Descripción                                                                               |
| ------------------------------- | ----------------------------------------------------------------------------------------- |
| `1 LOGIN username password`     | Mediante este comando indicamos las credenciales para iniciar sesión en el servidor.      |
| `1 LIST "" *`                   | Lista todas las **cajas de correo** presentes.                                            |
| `1 CREATE "INBOX"`              | Crea una nueva **caja de correo**, en este caso, con el nombre *INBOX*.                   |
| `1 DELETE "INBOX"`              | Borra una **caja de correo**, en este ejemplo, la que se llame *INBOX*.                   |
| `1 RENAME "ToRead" "Important"` | Renombra una **caja de correo**.                                                          |
| `1 LSUB "" *`                   | Devuelve un conjunto de nombres de cajas marcadas como **activass** o como **suscritas**. |
| `1 SELECT INBOX`                | Selecciona la caja de correo *INBOX*, para posteriormente poder listar su contenido.      |
| `1 UNSELECT INBOX`              | Anula la selección sobre la caja *INBOX*.                                                 |
| `1 SEARCH ALL`                  | Lista los identificadores de todos los correos en la **caja de correo** seleccionada.     |
| `1 FETCH <id> body[]`           | Recupera **todo** el contenido del correo con el identificador indicado.                  |
| `1 FETCH <id> body[header]`     | Recupera únicamente los **encabezados** del correo con el identificador indicado.         |
| `1 FETCH <id> body[text]`       | Recupera únicamente el **cuerpo** del correo con el identificador indicado.               |
| `1 CLOSE`                       | Elimina permanentemente todos los mensajes marcados como *"Borrados"*.                    |
| `1 LOGOUT`                      | Cierra la sesión y termina la conexión con el servidor.                                   |

#### POP3

| Comando         | Descripción                                                                  |
| --------------- | ---------------------------------------------------------------------------- |
| `USER username` | Indica el usuario con el que se desea iniciar sesión.                        |
| `PASS password` | Indica la contraseña del usuario indicado e inicia sesión en el servidor.    |
| `STAT`          | Solicita el numeros de correos almacenados en el servidor.                   |
| `LIST`          | Lista los correos presentes en el servidor junto con su tamaño en cada caso. |
| `RETR id`       | Se le indica el número del correo y recupera su contenido.                   |
| `DELE id`       | Elimina el correo con el número de identificación que se le indique.         |
| `CAPA`          | Solicita las características y funcionalidades del servidor.                 |
| `RSET`          | Solicita al servidor resetear toda la información transferida en la sesión.  |
| `QUIT`          | Cierra la sesión y termina la conexión con el servidor.                      |

## Configuraciones peligrosas

> Algunas de las opciones más peligrosas presentes en estos protocolos surgen a raíz de negligencias como de la **depuración de comandos**, **sesiones anónimas o predecibles**, **configuraciones inseguras sobre el servidor de correo privado**, etc.

En el peor de los casos, esto permite el acceso a todos los correos envíados y recibidos en la organización, probablemente conteniendo información sensible y confidencial.

| Opción                    | Descripción                                                                               |
| ------------------------- | ----------------------------------------------------------------------------------------- |
| `auth_debug`              | Permite la depuración de inicios de sesión.                                               |
| `auth_debug_passwords`    | Activa la depuración de las contraseñas y los mecanismos de autenticación.                |
| `auth_verbose`            | Incrementa la verbosidad al inicar sesión.                                                |
| `auth_verbose_passwords`  | Incrementa la verbosidad al indicar la contraseñas                                        |
| `auth_anonymous_username` | Mediante esta opción, se especifica el nombre del usuario anónimo y se permite su sesión. |

## Enumeración

### Nmap

Al enumerar con *Nmap* y con [NSE](../nmap/Nmap-NSE.md), no debemos olvidar considerar los puertos altos para las versiones con **comunicaciones encriptadas** de estos servicios.

> Mediante *Nmap*, podemos obtener detalles muy importantes como las funcionalidades que soporta, versión y para las variantes con *TLS/SSL* podemos obtener más detalles del nombre del servidor y dominio mediante su **certificado TLS/SSL**.

```bash
sudo nmap -p110,143,993,995 -sV -sC -n 10.129.49.90 

# Starting Nmap 7.95 ( https://nmap.org ) at 2025-01-22 23:31 CST
# Nmap scan report for 10.129.49.90
# Host is up (0.13s latency).
# 
# PORT    STATE SERVICE  VERSION
# 110/tcp open  pop3     Dovecot pop3d
# |_pop3-capabilities: AUTH-RESP-CODE UIDL PIPELINING TOP STLS RESP-CODES CAPA SASL
# 143/tcp open  imap     Dovecot imapd
# |_imap-capabilities: have more post-login listed ID Pre-login LOGIN-REFERRALS SASL-IR IDLE IMAP4rev1 OK capabilities LOGINDISABLEDA0001 ENABLE STARTTLS LITERAL+
# | ssl-cert: Subject: commonName=dev.inlanefreight.htb/organizationName=InlaneFreight Ltd/stateOrProvinceName=London/countryName=UK
# | Not valid before: 2021-11-08T23:10:05
# |_Not valid after:  2295-08-23T23:10:05
# 993/tcp open  ssl/imap Dovecot imapd
# | ssl-cert: Subject: commonName=dev.inlanefreight.htb/organizationName=InlaneFreight Ltd/stateOrProvinceName=London/countryName=UK
# | Not valid before: 2021-11-08T23:10:05
# |_Not valid after:  2295-08-23T23:10:05
# |_ssl-date: TLS randomness does not represent time
# |_imap-capabilities: more have AUTH=PLAINA0001 ID Pre-login LOGIN-REFERRALS SASL-IR IDLE IMAP4rev1 OK post-login listed ENABLE capabilities LITERAL+
# 995/tcp open  ssl/pop3 Dovecot pop3d
# |_pop3-capabilities: AUTH-RESP-CODE UIDL PIPELINING TOP USER RESP-CODES CAPA SASL(PLAIN)
# | ssl-cert: Subject: commonName=dev.inlanefreight.htb/organizationName=InlaneFreight Ltd/stateOrProvinceName=London/countryName=UK
# | Not valid before: 2021-11-08T23:10:05
# |_Not valid after:  2295-08-23T23:10:05
# |_ssl-date: TLS randomness does not represent time
# 
# Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done: 1 IP address (1 host up) scanned in 24.41 seconds
```

Por ejemplo, mediante el escaneo anterior y gracias a los detalles del certificado *SSL* del servidor enumerados mediante el *script* `ssl-cert`, identificamos el nombre de dominio del servidor (*FQDN*) como `dev.inlanefreight.htb`, el nombre de la organización `InlaneFreight Ltd`, el estado/provincia de residencia como `London` y el país de residencia como `UK`.

Todo esto, adicional a las funcionalidades listadas por los *scripts* `*-capabilities`.

### `ncat`

> Para interactuar correctamente con las variantes *TLS/SSL* de estos servicios, recomiendo altamente utilizar `ncat`, una utilidad basada en el clásica `nc` pero con unas cuantas mejoras en sus funcionalidades.
 
Precisamente, integra la compatibilidad *TLS/SSL*, de modo que podemos establecer conexiones con estas variantes de manera segura y estable cuando indicamos la bandera `--ssl`.

```bash
# IMAPS
ncat --ssl 10.129.49.90 993

# POP3S
ncat --ssl 10.129.49.90 995
```

De no poseer estas variantes, un simple `nc` o un `ncat` sin banderas es suficiente.

### `openssl`

> Otra manera que tenemos de interactuar con las variantes *TLS/SSL* es utilizar la utilidad `openssl`, en caso de no contar con `ncat` o simplemente si deseamos examinar con más detalle el establecimiento de la sesión *TLS*.

En pocas palabras, utilizar `openssl` tendrá el mismo efecto que los comandos `ncat` anteriores, pero imprimirá en pantalla mucha información acerca del establecimiento de la sesión cifrada y del certificado utilizado.

```bash
# IMAPS
openssl s_client -connect 10.129.49.90:imaps

# POP3S
openssl s_client -connect 10.129.49.90:pop3s
```

Otra ventaja, es que `openssl` viene instalada por defecto, siendo más probable que contemos con esta utilidad que con `ncat`.

---

Una vez establecida la conexión con el servidor mediante alguno de los métodos mencionados anteriormente, podemos continuar la enumeración mediante los comandos de cada protocolo para extraer toda la información útil de los correos.

# Enlaces

[<- SMTP](SMTP.md) | [SNMP ->](SNMP.md)