[<- Índice](../../../Pentesting.md)
# MySQL

> ***MySQL*** es un sistema de administración de bases de datos **relacionales**, de código abierto y mantenido por *Oracle*.

Una **base de datos** no es más que una colección estructurada y organizada de datos para su óptima consulta y almacenamiento.
Esta colección debe procesar eficientemente grandes volúmenes de datos, reservando la menor cantidad de espacio posible para almacenarlos, segun se necesite.

Las consultas a una base de datos se realizan en **SQL** (*Structured Query Language*), un lenguaje optimizado para especificar la información que necesitamos de la base.

***MySQL*** trabaja en un modelo **servidor-cliente** donde el servidor es el sistema de administración como tal y los clientes aquellos que consultan datos.
Estos datos se encuentran almacenados en **tablas** cada uno con distintas **columnas**, **filas** y **tipos de datos**.
Además, estas bases de datos suelen estar almacenados en archivos de extensión `.sql`.

### Clientes MySQL

Los clientes **MySQL** pueden consultar, modificar, eliminar e insertar información en la base de datos utilizando consultas *SQL*.
Además, las consultas en este lenguaje permiten interactuar con más de una base de datos simultáneamente.

### Bases de datos MySQl

El sistema de administración se aloja en el puerto **3306** del servidor como un servicio más, permitiendo su acceso al internet o a redes internas según se considere.
Por ejemplo *Wordpress* almacena todas las publicaciones, usuarios, contraseñas y demás datos en una base de datos accesible únicamente desde la interfaz *localhost*.

Estos sistemas de bases de datos son ideales para sitios web *dinámicos*, donde se espera eficiencia y rápidez a la hora de mantener y cargar los datos esperados para la página.
Por ejemplo, para un servidor *web* podríamos almacenar datos como:

- Usuarios
- Encabezados
- Clientes
- Correos electrónicos
- Permisos
- Textos
- Claves
- Etc

Datos sensibles como lo son las **contraseñas** puede almacenarse en texto plano en la base, sin embargo, en la práctica suele almacenarse encriptada por su seguridad.
Particularmente, mediante encriptaciones de una sola ida, donde no podemos recuperar el mensaje original, como lo son los *hashes*.

### Comandos MySQL

A través de una interfaz de línea de comandos que se nos habilita una vez que establecemos la conexión con la **base de datos** *MySQL*, podemos ejecutar comandos para interactuar con el complejo sistema de almacenamiento de datos.

Por detrás, estos comandos se convierten a código ejecutable que realiza las acciones solicitadas por el usuario.
Además la base de datos suele informar al usuario de advertencias y errores que hayan surgido durante la ejecución del comando.

Como sabemos, es mediante estos comandos que podemos recuperar, modificar, agregar o eliminar datos dentro del sistema, además de alterar la estructura de las tablas, los detalles de los usuarios, etc.

---

## Configuración

> Actualmente, **MariaDB**, un proyecto bifurcado a partir del código original de **MySQL**, es la opción más utilizada en desarrollos modernos pues heredó todas las características positivas del viejo **MySQL** y sigue bajo el mantenimiento constante del equipo de *Oracle*.

Por eso mismo, nos enfocaremos en las configuraciones típicas presentes en **MariaDB**, que podemos encontrar usualmente en el archivo `/etc/mysql/mysql.conf.d/mysqld.cnf` o `/etc/my.cnf`.

```bash
cat /etc/mysql/mysql.conf.d/mysqld.cnf | grep -v "#" | sed -r '/^\s*$/d'

# [client]
# port		= 3306
# socket		= /var/run/mysqld/mysqld.sock
# 
# [mysqld_safe]
# pid-file	= /var/run/mysqld/mysqld.pid
# socket		= /var/run/mysqld/mysqld.sock
# nice		= 0
# 
# [mysqld]
# skip-host-cache
# skip-name-resolve
# user		= mysql
# pid-file	= /var/run/mysqld/mysqld.pid
# socket		= /var/run/mysqld/mysqld.sock
# port		= 3306
# basedir		= /usr
# datadir		= /var/lib/mysql
# tmpdir		= /tmp
# lc-messages-dir	= /usr/share/mysql
# explicit_defaults_for_timestamp
# 
# symbolic-links=0
# 
# !includedir /etc/mysql/conf.d/
```

### Configuraciones peligrosas

Muchas cosas pueden configurarse erroneamente en un sistema tan complejo, pero entre las opciones mas relevantes se destaca:

| Opción             | Descripción                                                                                                 |
| ------------------ | ----------------------------------------------------------------------------------------------------------- |
| `user`             | Define el usuario bajo el que se ejecuta el servicio *MySQL*.                                               |
| `password`         | Define la contraseña del usuario *MySQL*, utilizable para autenticarse en el servicio.                      |
| `admin_address`    | Define la dirección IP desde la que se escucha para conexiones entrantes especiales, de uso administrativo. |
| `debug`            | Indica el nivel de verbosidad para la depuración de errores del servidor.                                   |
| `sql_warnings`     | Indica si se imprimen o envían advertencias durante cualquier eventualidad en las operaciones.              |
| `secure_file_priv` | Se usa para limitar el efecto de la importación y exportación de datos.                                     |

Las opciones de `user`, `password` y `admin_addresss` son especialmente relevantes porque se almacenan en texto plano en este archivo.
Si no se definen adecuadamente los permisos de éste, o si conseguimos leer dicho archivo mediante alguna vulnerabilidad podríamos comprometer la integridad de toda la base de datos y de la información sensible almacenada en ella.

Por otra parte, las opciones de `debug` y `sql_warnings` representan un riesgo porque brindan **verbosidad** en la salida de las consultas, lo que podría ser aprovechado por algunas vulnerabilidades, como lo son las **inyecciones SQL**.

# Enumeración

### Nmap

> Como se mencionó antes, un servidor *MySQL* suele estar alojado en el puerto **3306** del objetivo, de modo que podemos escanearlo con **Nmap** para obtener información detallada.

```bash
sudo nmap 10.129.110.161 -sV -vv --min-rate 2000 -n -p3306 --script "mysql*"

# ...
# Scanned at 2025-05-07 22:40:33 CST for 610s
# 
# PORT     STATE SERVICE REASON         VERSION
# 3306/tcp open  mysql   syn-ack ttl 63 MySQL 8.0.27-0ubuntu0.20.04.1
# | mysql-info: 
# |   Protocol: 10
# |   Version: 8.0.27-0ubuntu0.20.04.1
# |   Thread ID: 12
# |   Capabilities flags: 65535
# |   Some Capabilities: Speaks41ProtocolOld, Support41Auth, LongPassword, IgnoreSigpipes, LongColumnFlag, SupportsTransactions, SwitchToSSLAfterHandshake, ConnectWithDatabase, ODBCClient, InteractiveClient, SupportsLoadDataLocal, FoundRows, SupportsCompression, IgnoreSpaceBeforeParenthesis, Speaks41ProtocolNew, DontAllowDatabaseTableColumn, SupportsAuthPlugins, SupportsMultipleStatments, SupportsMultipleResults
# |   Status: Autocommit
# |   Salt: \x05?\x1C\x07\x0DF\x1A8V\x01qs\x16\x11\x13"\x16se\x0E
# |_  Auth Plugin Name: caching_sha2_password
# | mysql-enum: 
# |   Accounts: No valid accounts found
# |_  Statistics: Performed 9 guesses in 6 seconds, average tps: 1.5
# | mysql-brute: 
# |   Accounts: No valid accounts found
# |   Statistics: Performed 33911 guesses in 603 seconds, average tps: 54.3
# |_  ERROR: The service seems to have failed or is heavily firewalled...
```

Como ya sabemos, **Nmap** posee muchos scripts que pueden brindarnos información muy relevante del servidor, pero siempre es buena idea revisarlo manualmente para determinar cualesquiera falsos positivos.

### Interacción manual

Para establecer la conexión con la base de datos, suponiendo que tenemos conocimiento de algunas credenciales, podemos utilizar la utilidad `mariadb` o `mysql` de la siguiente manera: `mariadb -u <usuario> -p -h <IP>`.

Por ejemplo:

```bash
mariadb -u robin -p -h 10.129.14.128 --skip-ssl
```

Nota: Aquí agregué la bandera `--skip-ssl` para omitir la verificación del certificado *SSL* del servidor y omitir un error porque este no este firmado.

Una vez autenticados, se nos habra desplegado la interfaz de línea de comandos, donde podemos introducir ordenes en lenguaje *SQL*.

```mariadb
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 380
Server version: 8.0.27-0ubuntu0.20.04.1 (Ubuntu)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]>
```

Podemos realizar una rápida consulta de las bases de datos con el comando `show databases;`, seleccionar alguna con `use <nombre_base_de_datos>;` y enumerar las tablas con `show tables;`.

```mariadb
MySQL [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| customers          |
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
5 rows in set (0.910 sec)

MySQL [(none)]> use customers;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MySQL [customers]> show tables;
+---------------------+
| Tables_in_customers |
+---------------------+
| myTable             |
+---------------------+
1 row in set (0.109 sec)

MySQL [customers]>
```

De los puntos más importantes a la hora de enumerar son las bases de datos **system schema** (`sys`) y la vital **information schema** (`information_schema`).

**System schema** contiene toda la información detallada y metadatos necesarios para la administración del servidor.
Mientras que **information schema** contiene especificamente metadatos acerca de otras bases de datos presentes en el servidor, en un formato más legible y estandarizado.

Concluyendo, algunos de los comandos más útiles para la enumeración podrían ser:

| Comando                                            | Descripción                                                                                        |
| -------------------------------------------------- | -------------------------------------------------------------------------------------------------- |
| `mariadb -u <usuario> -p<contraseña> -h <IP>`      | Establece una conexión en el servidor *MySQL*, autenticandose con las credenciales proporcionadas. |
| `show databases;`                                  | Imprime todas las bases de datos presentes en el servidor                                          |
| `use <base_de_datos>;`                             | Selecciona la base de datos indicada                                                               |
| `show tables;`                                     | Imprime todas las tablas de la base de datos seleccionada                                          |
| `show columns from <tabla>;`                       | Imprime las columnas de la tabla indicada en la base de datos seleccionada anteriormente           |
| `select * from <tabla>;`                           | Imprime todo el contenido de la tabla indicada                                                     |
| `select * from <tabla> where <columna> = "<algo>"` | Filtra el contenido de la tabla según el valor de alguna columna                                   |

# Enlaces

[<- SNMP](SNMP.md) | [MSSQL ->](MSSQL.md)