[<- Índice](../../../Pentesting.md)
# Protocolos de Administración Remota Windows

La **administración remota** en dispositivos *Windows* se encuentra preconfigurada y habilitada por defecto en versiones *Windows* de servidor a partir de **Windows Server 2016**.

Se considera incluso un componente esencial de la ==*suite* de administración de *hardware* *Windows*== que permite gestionar tanto local como remotamente el *hardware* de los dispositivos.

Entre estas funcionalidades, incluye una implementación del protocolo **WS-Management**, diagnosticos de *hardware* y control de la placa base mediante *drivers* y controladores.
Esta *suite* también incluye una **API COM** y varios *scripts* y objetos que permiten el desarrollo de aplicaciones que se comuniquen remotamente mediante el protocolo **WS-Management**.

En general, la administración remota convencional de *Windows* y *Windows Server* se realiza principalmente con apoyo de los siguientes protocolos:

- ***RDP*** (*Remote Desktop Protocol*)
- ***WinRM*** (*Windows Remote Management*)
- ***WMI*** (*Windows Management Instrumentation*)

---
## Remote Desktop Protocol

> ***RDP*** es un protocolo desarrollado por *Microsoft* para el acceso remoto a computadoras *Windows*.
> Este protocolo permite compartir y transmitir el **entorno gráfico** del equipo remoto a través de la red, mediante una comunicación cifrada.

**RDP** funciona en la capa de aplicación del modelo **TCP/IP** y típicamente se encuentra a la escucha en el puerto *TCP* **3389** aunque algunas implementaciones del protocolo también permiten la administración mediante el protocolo *UDP* en el mismo puerto, **3389**.

Para que pueda establecerse una conexión **RDP**, tanto el *Firewall* del cliente como el del servidor deben permitir conexiones **externas**.
Además, en caso de atravesar cualquier mecanismo de **NAT** (*Network Address Translation*), el servidor o equipo remoto debe conocer la *IP* pública adecuada para alcanzar el cliente y el *router NAT* presente debe configurarse adecuadamente para realizar la **redirección de puertos** al equipo correcto.

**RDP** soporta nativamente la encriptación *TLS/SSL* desde sus versiones en *Windows Vista*, lo que ayuda a proteger la información en transito durante la comunicación y especialmente el proceso de inicio de sesión.

Aunque es una gran medida de seguridad, algunos sistemas *Windows* malconfigurados pueden aceptar algoritmos de encriptación débiles o inadecuados por medio de los ajustes de **RDP Security**.

Sin embargo, un atacante aún puede aprovecharse de los certificados de identidad, pues estos son **autofirmados** de modo que un cliente no puede distinguir un certificado genuino de un servidor de uno falsificado por un atacante, posibilitando ataques de tipo **MITM** (*Man in the middle*).

Este servicio, se encuentra preinstalado por defecto en servidores *Windows* y no requiere de ninguna aplicación externa para funcionar.
Puede ser configurado utilizando la aplicación **Server Manager** incluida en versiones *Windows Server*, pero por defecto únicamente permite conexiones al servicio con **autenticación a nivel de red** o **NLA** (*Network level authentication*).

### Enumeración

#### Nmap

Podemos enumerar rápidamente el servicio con **Nmap** y sus *scripts* para obtener rápidamente mucha información útil del servicio, por ejemplo, determinar si se encuentra habilitada la autenticación **NLA** (*Network Level Authentication*), la versión del servicio y detalles del servidor.

```bash
nmap -sV -sC 10.129.201.248 -p3389 --script rdp*

# Starting Nmap 7.92 ( https://nmap.org ) at 2021-11-06 15:45 CET
# Nmap scan report for 10.129.201.248
# Host is up (0.036s latency).
# 
# PORT     STATE SERVICE       VERSION
# 3389/tcp open  ms-wbt-server Microsoft Terminal Services
# | rdp-enum-encryption: 
# |   Security layer
# |     CredSSP (NLA): SUCCESS
# |     CredSSP with Early User Auth: SUCCESS
# |_    RDSTLS: SUCCESS
# | rdp-ntlm-info: 
# |   Target_Name: ILF-SQL-01
# |   NetBIOS_Domain_Name: ILF-SQL-01
# |   NetBIOS_Computer_Name: ILF-SQL-01
# |   DNS_Domain_Name: ILF-SQL-01
# |   DNS_Computer_Name: ILF-SQL-01
# |   Product_Version: 10.0.17763
# |_  System_Time: 2021-11-06T13:46:00+00:00
# Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
# 
# Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done: 1 IP address (1 host up) scanned in 8.26 seconds
```

Aunque útil, presenta un problema que podemos analizar con la bandera `--packet-trace`.
Durante la enumeración del servicio, `nmap` indica por defecto una *Cookie* `mstshash=nmap` que envia en texto plano al servidor.
Aunque es un detalle pequeño, es comunmente utilizado por el personal defensivo y controles de defensa como **EDR** (*Endpoint Detection and Response*) para detectar nuestra enumeración y podría incluso bloquear nuestro acceso al servicio en redes bien configuradas.

```bash
nmap -sV -sC 10.129.201.248 -p3389 --packet-trace --disable-arp-ping -n

# Starting Nmap 7.92 ( https://nmap.org ) at 2021-11-06 16:23 CET
# 
# ...
# 
# NSOCK INFO [6.5610s] nsock_write(): Write request for 54 bytes to IOD #1 EID 27 [10.129.201.248:3389]
# NSE: TCP 10.10.14.20:36630 > 10.129.201.248:3389 | 00000000: 03 00 00 2a 25 e0 00 00 00 00 00 43 6f 6f 6b 69    *%      Cooki
# 00000010: 65 3a 20 6d 73 74 73 68 61 73 68 3d 6e 6d 61 70 e: mstshash=nmap
# 00000020: 0d 0a 01 00 08 00 0b 00 00 00  
# 
# ...
```

Por esta razón, siempre es buena idea conocer otras alternativas de enumeración, por ejemplo...

#### RDP Security Check

El equipo de **Cisco CX Security Labs** desarrolló un famoso *script* en **Perl** que puede enumerar sin autenticación varios aspectos y configuraciones de seguridad de servidores **RDP** únicamente basado en los *handshakes* que se realizan durante la comunicación.

##### Instalación

Para instalarlo, lo primero es instalar los paquetes necesarios con el gestor de paquetes de **Perl**, `cpan`.

Lo primero es ejecutar `cpan` con permisos *root*:

```bash
sudo cpan
```

Dentro del programa, debemos indicar `yes` cuando se nos pregunte si deseamos que se configure automaticamente todo lo posible y despues indicar la instrucción `install Encoding::BER` en cuanto se despliegue la línea de comandos.

##### Uso

Una vez que termine la instalación, podemos clonar el repositorio de este proyecto y utilizar el script sin problema:

```bash
git clone https://github.com/CiscoCXSecurity/rdp-sec-check.git && cd rdp-sec-check

# ...

./rdp-sec-check.pl 10.129.201.248

# Starting rdp-sec-check v0.9-beta ( http://labs.portcullis.co.uk/application/rdp-sec-check/ ) at Sun Nov  7 16:50:32 2021
# 
# [+] Scanning 1 hosts
# 
# Target:    10.129.201.248
# IP:        10.129.201.248
# Port:      3389
# 
# [+] Checking supported protocols
# 
# [-] Checking if RDP Security (PROTOCOL_RDP) is supported...Not supported - HYBRID_REQUIRED_BY_SERVER
# [-] Checking if TLS Security (PROTOCOL_SSL) is supported...Not supported - HYBRID_REQUIRED_BY_SERVER
# [-] Checking if CredSSP Security (PROTOCOL_HYBRID) is supported [uses NLA]...Supported
# 
# [+] Checking RDP Security Layer
# 
# ...
```

#### Iniciar una sesión RDP

Actualmente existen muchas alternativas para establecer una conexión con un servidor **RDP** y poder interactuar con su **GUI** (*interfaz gráfica*), como lo son `xfreerdp`, `rdesktop` o `Remmina`.

Uno de los favoritos sin duda es `xfreerdp` y la sintaxis para conectarse es la siguiente:

- `xfreerdp /u:<usuario> /p:"<contraseña>" /v:<IP/dominio>`

Por ejemplo:

```bash
xfreerdp /u:cry0l1t3 /p:"P455w0rd!" /v:10.129.201.248

# ...
#
# Certificate details for 10.129.201.248:3389 (RDP-Server):
#         Common Name: ILF-SQL-01
#         Subject:     CN = ILF-SQL-01
#         Issuer:      CN = ILF-SQL-01
#         Thumbprint:  b7:5f:00:ca:91:00:0a:29:0c:b5:14:21:f3:b0:ca:9e:af:8c:62:d6:dc:f9:50:ec:ac:06:38:1f:c5:d6:a9:39
# The above X.509 certificate could not be verified, possibly because you do not have
# the CA certificate in your certificate store, or the certificate has expired.
# Please look at the OpenSSL documentation on how to add a private CA to the store.
# 
# 
# Do you trust the above certificate? (Y/T/N) y
#
# ...
```

Tras una autenticación exitosa, se nos desplegará una nueva ventana reflejando el entorno gráfico del dispositivo remoto.

---
## WinRM

> ***WinRM*** (*Windows Remote Management*) es un protocolo simple de adminstración remota *Windows* basado de una línea de comandos, de forma similar a *SSH*.
> Este servicio usa el protocolo ***SOAP*** (*Simple Object Access Protocol*) como base para establecer conexiones entre dispositivos y aplicaciones.

Funcionalidades como sesiones remotas de *Powershell* y fusión de *logs* de eventos dependen en gran parte de este servicio.

A partir de *Windows Server 2012*, este servicio ya se encuentra habilitado por defecto, pero debe ser correctamente configurado por ejemplo, si se desea que sea compatible con servidores y clientes más viejos o si se desea adaptar las restricciones del *Firewall* para el uso cómodo del servicio.
Sin embargo, **WinRM** debe ser explicitamente habilitado y configurado desde *Windows* 10 en sistemas que no sean servidores.

**WinRM** se ubica en los puertos *TCP* **5985** y **5986** para sus comunicaciones, y utilizan los protocolos *HTTP* y *HTTPS* respectivamente para comunicarse en capa de aplicación.

Otra herramienta relacionada con **WInRM** es ***WinRS*** (*Windows Remote Shell*), una utilidad que permite ejecutar comandos arbitrarios en sistemas remotos, incluido en versiones viejas de *Windows* como la **7** por defecto.

### Enumeración

#### Nmap

Ya conociendo los puertos del servicio, podemos hacer una enumeración básica con apoyo de **Nmap**.
Muchas veces podríamos encontrarnos con que el puerto *HTTPS* de este servicio (**5986**) se enceuntra deshabilitado y solo se utiliza la versión *HTTP*.
Esto depende completamente de la configuración asignada por el administrador.

```bash
nmap -sV -sC 10.129.201.248 -p5985,5986 --disable-arp-ping -n

# Starting Nmap 7.92 ( https://nmap.org ) at 2021-11-06 16:31 CET
# Nmap scan report for 10.129.201.248
# Host is up (0.030s latency).
# 
# PORT     STATE SERVICE VERSION
# 5985/tcp open  http    Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
# |_http-title: Not Found
# |_http-server-header: Microsoft-HTTPAPI/2.0
# Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
# 
# Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done: 1 IP address (1 host up) scanned in 7.34 seconds
```

#### Test-WsMan y `evil-winrm`

Otra manera de evaluar el estado del servicio desde un sistema *Windows* es utilizando el **cmdlet** `Test-WsMan`, una función responsable de evaluar el estado del servicio y recuperar información básica de este.

Por otra parte, para interactuar directamente con el servicio y ejecutar comandos podemos utilizar la herramienta `evil-winrm` en sistemas *Linux*, una herramienta para pruebas de penetración que se conecta al servicio, simula una línea de comandos y ejecuta las instrucciones que le indiquemos.

```bash
evil-winrm -i 10.129.201.248 -u Cry0l1t3 -p P455w0rD!

# Evil-WinRM shell v3.3
# 
# Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
# 
# Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
# 
# Info: Establishing connection to remote endpoint
# 
# *Evil-WinRM* PS C:\Users\Cry0l1t3\Documents>
```

---
## WMI

---
# Enlaces

[<- Administración remota Linux](Linux_GestionRemota.md) |