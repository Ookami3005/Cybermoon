[<- Índice](../../../Pentesting.md)
# *Nmap Script Engine*

## Introducción

> Por supuesto, *Nmap* por si solo es un escaner de puertos versátil, poderoso, práctico y muy personalizable. Pero una de las funcionalidades que realmente lo llevó a otro nivel es ***Nmap Script Engine*** un *framework* que interpreta codigo escrito en *Lua* para ejecutar ciertos procedimientos extra sobre puertos abiertos o incluso sobre el objetivo.

El hecho de que esta herramienta sea de código abierto tuvo un gran papel en el desarrollo de los muchisimos *Scripts* con los que contamos hoy en dia, catapultando *NSE* y *Nmap* mucho más allá del pensado inicialmente.

Actualmente, *Nmap* incluye los *Scripts* más utilizados en su instalación, ubicados por defecto en el directorio `/usr/share/nmap/scripts` con extensiones `.nse`. Son tantos que se establecieron categorías para clasificarlos adecuadamente, las importantes (pero no todas) son:

## Categorías

### *Safe*

> La **mayoría** de los *Scripts* a continuación, son considerados como ***Scripts seguros***, es decir, *Scripts* que no representan ninguna intrusión o procedimiento agresivo contra el objetivo.

En esta categoría es muy probable encontrar *Scripts* de categorías como:

#### Auth

*Scripts* con el objetivo de ==recopilar información respecto a la autenticación== en un **servicio específico** del objetivo, por ejemplo con credenciales por defecto o provistas por el usuario. ***No se busca realizar fuerza bruta ni ninguna forma de ataque*** aunque algunos si pueden hacerlo.

**Ejemplos**:

- `ftp-anon`: Verifica si podemos acceder al servicio *ftp* como invitado (*Anonymous*).
- `http-default-accounts`: Intenta determinar aplicaciones *web* basado en una base de patrones e intenta autenticarse con las credenciales por defecto de esas aplicaciones.
- `ssh-auth-metods`: Indica los métodos de autenticación permitidos por el servicio *ssh*
- `mysql-users`: Intenta enumerar todos los usuarios válidos para el servicio *mysql*
- `http-auth`: Verifica si el servidor *http* requiere de autenticación, y en caso de haber, recupera toda la información al respecto que pueda como el tipo de autenticación, el *Realm* o sección, etc.

#### Discovery

*Scripts* pensados para **descubrir más información sensible** sobre los servicios interactuando directamente con ellos, esta es una categoría muy versátil y variada, podemos desde busqueda de configuraciones, como de directorios, de versiones, de registros, dispositivos, etc.

**Ejemplos**:

- `dhcp-discover`: Realiza una consulta *DHCP* para obtener toda la información disponible para un dispositivo sin dirección *IP*  asignada

- `dns-zone-transfer`: Solicita una transferencia de zona al servicio *DNS* y reporta los resultados

- `http-title`: Recupera el titulo del servidor web.

- `http-enum`: Intenta determinar la aplicación *web* y su versión y realiza una enumeración de los recursos más populares para estas aplicaciones *Web* y Servidores

- `http-auth-finder`: Realiza *spidering* sobre el servidor *web* para enumerar los recursos de autenticación, ya sean **formularios web**  o **Autenticación HTTP** (*Basic*, *Digest*, etc)

- `http-backup-finder`: Intenta encontrar respaldos de los archivos encontrado, mediante convenciones y modificaciones típicas como la extensión `.bak` 

#### External

Estos *Scripts* consultan *bases de datos* y/o fuentes externas para recopilar información de los objetivos **indirectamente**, perfecto para realizar ***reconocimiento pasivo***.

**Ejemplos**:

- `whois-ip`: Consulta información de la **IP** de los servicios de *WHOIS*, que poseen la información del *Regional Internet Registries* (**RIR**). ==Se espera que le hayas proveido una **dirección IP** a Nmap como objetivo==.

- `whois-domain`: Recupera la información disponible sobre el **nombre de dominio** de los servicios de *WHOIS*. ==Se espera que en el comando, se haya proveído un **nombre de dominio** como objetivo==.

- `http-google-malware`: Revisa si el objetivo se encuentra en las ***listas negras de Google*** sobre servidores de *Malware* y/o *Phishing*.

- `dns-blacklist`: Revisa si la **dirección IP objetivo** se encuentra en listas negras de otros *DNS* o *Proxies* conocidos.

#### Version

*Scripts* que ***extienden*** la funcionalidad del ***escaneo de servicios*** seleccionable con la opción `-sV` en terminal. Por esto mismo, solo se ejecutan cuando seleccionamos este tipo de escaneo.

### *Intrusive*

> *Scripts* considerados como **intrusivos o agresivos** contra el objetivo. Aqui encontramos enumeraciones invasivas o maliciosas por ejemplo, muy posiblemente detectadas por las defensas del objetivo.

En esta ocasión, econtramos *Scripts* de categorías como:

#### Brute

Este tipo de *Scripts* ***realiza fuerza bruta sobre la autenticación de servicios o para la enumeración de información***.

**Ejemplos**:

- `http-form-brute`: Realiza fuerza bruta sobre formularios *web*.

- `imap-brute`: Realiza fuerza bruta sobre la autenticación de *IMAP* en varios formatos.

- `ssh-brute`: Fuerza bruta sobre el acceso a *SSH*.

- `mysql-enum`: Enumera mediante fuerza bruta los usuarios válidos del servicio de *MySQL*.

#### Vuln

*Scripts* que, ***generalmente***, detectan vulnerabilidades y únicamente las reportan.

Muchos *Scripts* realizan detecciones sencillas y no-invasivas, además de efectivamente **solo** reportan los resultados, por lo que realmente están clasificados como ***Safe***.

Sin embargo, muchos otros requieren de enumeraciones mucho más invasivas e incluso intentan explotarla de una vez.
Por esto último, pienso que esta categoría debe considerarse principalmente como ***Intrusive***.

**Ejemplos**:

- `ssl-heartbleed`: Detecta si un servidor es vulnerable al bug *SSL HeartBleed*.
- `http-sql-injection`: Realiza *spidering* sobre la aplicación *web*, detectando enlaces o formularios susceptibles a inyecciones *SQL*.
- `http-shellshock`: Detecta si un servidor *web* es vulnerable a *ShellShock*
- `service-vuln-id`: La sintaxis convencional de los *Scripts*, verifica la vulerabilidad `id` del servicio indicado

### Exploit

*Scripts que intentan explotar activamente una vulnerabilidad en el objetivo*

**Ejemplos**:

- `http-fileupload-exploiter`: Intenta aprovechar un **formulario de carga de archivos *inseguro*** mediante las técnicas más utilizadas.

- `smb-vuln-...`: Muchos *Scripts* que detectan e intentan explotar vulnerabilidades sobre el servicio *SMB* 
- `http-vuln-...`: Lo mismo pero para *HTTP*

#### Denial of Service (DoS)

*Scripts* cuyo propósito es abrumar o saturar al objetivo, incluso llegando a **tirar** el objetivo en lo que comúnmente se llama un ***ataque Denial of Service***.

Algunos buscan saturar las conexiones, otros aprovechar vulnerabilidades *DoS* y otros simplemente puede ser un efecto secundario de una **enumeración agresiva** o cualquier otro **procedimiento altamente intrusivo**. 

- `smb-flood`: Intenta saturar las conexiones de un servidor *SMB*, realizando todas las peticiones posibles.
- `smb-vuln-...`: Muchos *Scripts* de este tipo al intentar detectar vulnerabilidades del servicio *SMB*, son tan agresivos que podrían abrumar o tirar el objetivo.

### *Default*

> En esta categoría, hay *Scripts* varios que se consideran de utilidad en la mayoría de los escaneos. Se consideran *Scripts* valiosos pero poco intrusivos, además de enfocarse en los servicio más utilizados.

## Uso

> Ahora que conocemos las principales categorías de *Scripts*, podemos utilizarlos en el comando con la bandera `--script` seguido de la categoría o el nombre del *Script* que deseamos utilizar.

#### Scripts por Default

```bash
nmap -sC scanme.nmap.org # Equivalente a --script default

# PORT   STATE    SERVICE
# 22/tcp open     ssh
# | ssh-hostkey: 
# |   1024 ac:00:a0:1a:82:ff:cc:55:99:dc:67:2b:34:97:6b:75 (DSA)
# |   2048 20:3d:2d:44:62:2a:b0:5a:9d:b5:b3:05:14:c2:a6:b2 (RSA)
# |   256 96:02:bb:5e:57:54:1c:4e:45:2f:56:4c:4a:24:b2:57 (ECDSA)
# |_  256 33:fa:91:0f:e0:e1:7b:1f:6d:05:a2:b0:f1:54:41:56 (ED25519)
# 25/tcp filtered smtp
# 53/tcp open     domain
# 80/tcp open     http
# |_http-title: Go ahead and ScanMe!
# |_http-favicon: Nmap Project
```

Como podemos ver, los *Scripts* `http-title`, `http-favicon` y `ssh-hostkey` reportaron resultados.

#### Scripts de Autenticación

```bash
nmap --script auth scanme.nmap.org

# PORT    STATE    SERVICE
# 22/tcp  open     ssh
# | ssh-publickey-acceptance: 
# |_  Accepted Public Keys: No public keys accepted
# | ssh-auth-methods: 
# |   Supported authentication methods: 
# |     publickey
# |_    password
# 25/tcp  filtered smtp
# 53/tcp  open     domain
# 80/tcp  open     http
# 135/tcp filtered msrpc
```

Recuperamos información sobre la autenticación por *SSH*.

#### Enumeración de autenticación *HTTP*

```bash
nmap -p80 --script http-auth-finder 192.168.90.1

# PORT   STATE SERVICE
# 80/tcp open  http
# | http-auth-finder: 
# | Spidering limited to: maxdepth=3; maxpagecount=20; withinhost=192.168.90.1
# |   url                       method
# |_  http://192.168.90.1:80/  FORM
```

#### Reconocimiento pasivo por `whois`

```bash
nmap -sn --script whois-ip -n 8.8.8.8

# Host script results:
# | whois-ip: Record found at whois.arin.net
# | netrange: 8.8.8.0 - 8.8.8.255
# | netname: GOGL
# | orgname: Google LLC
# | orgid: GOGL
# | country: US stateprov: CA
# | orgtechname: Google LLC
# |_orgtechemail: arin-contact@google.com
```

### Expresiones booleanas

> Podemos especificar una selección mas específica de *Scripts* mediante expresiones *booleanas* de Lua.

##### Escaneo de vulnerabilidades seguro

```bash
nmap --script 'vuln and safe' -F 192.168.90.1

# PORT   STATE    SERVICE
# 22/tcp filtered ssh
# 23/tcp open     telnet
# 53/tcp open     domain
# 80/tcp open     http
# | http-slowloris-check: 
# |   VULNERABLE:
# |   Slowloris DOS attack
# |     State: LIKELY VULNERABLE
# |     IDs:  CVE:CVE-2007-6750
# |       Slowloris tries to keep many connections to the target web server open and hold
# |       them open as long as possible.  It accomplishes this by opening connections to
# |       the target web server and sending a partial request. By doing so, it starves
# |       the http server's resources causing Denial Of Service.
# |       
# |     Disclosure date: 2009-09-17
# |     References:
# |       http://ha.ckers.org/slowloris/
# |_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2007-6750
```

##### Escaneo de autenticación y fuerza bruta, no intrusivo

```bash
nmap --script '(auth or discovery) and not intrusive' -F 192.168.90.1
```

## Argumentos

> Algunos *Scripts*, reciben argumentos ya sea obligatorios u opcionales para el correcto desempeño de estos.

Podemos indicarselo en pares de la forma `id=value`, indicandolos con la bandera `--script-args`.

Por ejemplo, según la documentación, podemos indicarle una lista de usuarios y contraseñas al *Script* `ssh-brute` para que realice el ataque de fuerza bruta con dichos diccionarios.

```bash
nmap -p22 --script ssh-brute --script-args 'userdb=users.txt,passdb=rockyou.txt' [IP]
```

# Enlaces

[<- Ritmo y Optimización](Nmap-Ritmo.md) | [Evasión ->](Nmap-Evasion.md)