[<- Índice](../../../Pentesting.md)
# Evasión de Firewall e IDS/IPS

> *Nmap* ofrece distintas funcionalidades que podrían permitirnos evadir controles defensivos como *Firewalls* o *IDS/IPS*, como lo pueden ser la fragmentación de paquetes, el uso de señuelos y demás.

## Antecedentes

#### Firewall

> Recordemos que un *Firewall* es un control de seguridad que imposibilita las conexiones externas e internas según un conjunto de reglas establecidas. Es decir, monitoreo el tráfica de red y determina si permite, bloquea o ignora las conexiones entrantes y salientes según le sea especificado por un conjunto de reglas.

#### IDS/IPS

> Con un comportamiento similar al *Firewall*, los *IDS* monitorean el tráfico de red, lo analizan y reportan cualquier anormalidad en este según su conjunto de reglas. Por otra parte, el *IPS* complementa a los *IDS* tomando medidas activas de fensa contra las amenazas detectadas, por ejemplo, impidiendo futuras conexiones.

# Técnicas de evasión

## Firewall

Como dijimos anteriormente, el *Firewall* puede **rechazar** o **ignorar** los paquetes. En caso de **ignorarlos** no recibiremos respuesta alguna del puerto mientras que si los **bloquea**, muy probablemente recibamos algún mensaje de error *ICMP* como:

- *Net Unreachable*
- *Net Prohibited*
- *Host Unreachable*
- *Host Prohibited*
- *Port Unreachable*
- *Proto Unreachable*

Como se menciono en las [técnicas de escaneo](Nmap-TecnicasEscaneo.md), uno de nuestras mejores herramientas es el escaneo ***TCP-ACK*** (`-sA`), ya que resulta algo más dificil de filtrar para los *Firewalls*, pues, dada la naturaleza de *ACK*, el *Firewall* podría intentar (sin éxito) determinar cuando se originó la conexión.

```bash
nmap -sA -p22,23,80 192.168.90.1 --packet-trace

# SENT (0.2789s) TCP 192.168.90.76:43694 > 192.168.90.1:22 A ttl=56 id=11185 iplen=40  seq=0 win=1024 
# SENT (0.2789s) TCP 192.168.90.76:43694 > 192.168.90.1:80 A ttl=38 id=2325 iplen=40  seq=0 win=1024 
# SENT (0.2789s) TCP 192.168.90.76:43694 > 192.168.90.1:23 A ttl=46 id=8711 iplen=40  seq=0 win=1024 
# RCVD (0.2827s) TCP 192.168.90.1:80 > 192.168.90.76:43694 R ttl=64 id=0 iplen=40  seq=1369214747 win=0 
# RCVD (0.2833s) TCP 192.168.90.1:23 > 192.168.90.76:43694 R ttl=64 id=0 iplen=40  seq=1369214747 win=0 
# SENT (1.3802s) TCP 192.168.90.76:43696 > 192.168.90.1:22 A ttl=39 id=53245 iplen=40  seq=0 win=1024

# PORT   STATE      SERVICE
# 22/tcp filtered   ssh
# 23/tcp unfiltered telnet
# 80/tcp unfiltered http
```

## IDS/IPS

> A diferencia de los *Firewalls*, los *IDS/IPS* son sistemas defensivos mucho más complejos, pues examinan el tráfico de red de manera mayormente pasiva, haciendo más dificil el análisis de su comportamiento.

Consecuentemente, tenemos que ser más sigilosos con nuestros escaneos, e incluso disfrazar todas las interacciones con los objetivos y sus servicios, por ejemplo, mediante otras IPs.

### Señuelos (Decoys)

> *Nmap* permite realizar un escaneo con señuelos, que consiste en mandar paquetes de red para el escaneo con direcciones *IP* de origen distintas, haciendo parecer que todos esos dispositivos están realizando el escaneo y haciendo más díficil discernir que dispositivo es el verdadero autor para el objetivo.

Indicamos este **escaneo con señuelos** mediante la bandera `-D` seguida de las direcciones *IP* a utilizar como señuelo y de la palabra clave `ME` donde deseemos que introduzca nuestra dirección *IP* auténtica.

```bash
sudo nmap -D 10.10.10.23,121.34.56.78,ME,192.168.73.2 192.168.90.1 --packet-trace
```

Es altamente recomendable y casi mandatorio que las direcciones *IP* específicadas sean de dispositivos activos, de lo contrario, y según el numero de señuelos, podríamos causar o detonar las alertas de un *"SYN Flooding"* (saturar al dispositivo de paquetes *SYN* sin respuesta).

Sin embargo, si optamos por no tomar en cuenta esta recomendación, *Nmap* puede generar aleatoriamente las direcciones *IP* mediante la palabra clave `RND` seguido de dos puntos (`:`) y el número de direcciones deseadas.

```bash
sudo nmap -D RND:6 192.168.90.1 --packet-trace
```

### Direcciones IP alternativas

Adicionalmente, si deseamos escanear desde otra dirección *IP* que si controlamos, podemos usar las opciones `-S` y `-e` para indica al escaneo desde que dirección *IP* escanear y mediante que interfaz de red respectivamente.

Por ejemplo:

```bash
sudo nmap -S 10.21.34.18 -e tun0 10.21.34.78
```

Podriamos obtener mejores resultados dependiendo de la dirección *IP* que utilicemos y la relación que tenga con la empresa, pero claro que no es sencillo impersonar *IP*'s de la organización.

### Puertos de origen

> Muchas veces los administradores malconfiguran sus controles de defensa, por ejemplo, para permitir consultas *DNS* de otros dispositivos. De ser el caso, los puertos de origen desde los que se origine el paquete de red son **clave** para determinar si los controles de defensa permiten el paso o no al paquete.

Siendo así, un escaneo normal sería totalmente rechazado por los controles de defensa, pero si forzamos el puerto de origen al 53, mediante la bandera `--source-port`, podríamos correr con suerte y obtener mejores resultados.

```bash
sudo nmap 10.21.34.78 --source-port 53
```

# Enlaces

[<- NSE](Nmap-NSE.md) |