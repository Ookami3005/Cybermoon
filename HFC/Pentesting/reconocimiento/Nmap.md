[<- Índice](../Pentesting.md)
# Nmap básico

> ***Nmap*** (*Network Mapper*) es una de las herramientas más poderosas de ciberseguridad jamás creadas, a lo largo de los ==más de 20 años== que lleva existiendo se ha convertido en un ***estándar del reconocimiento activo*** tanto para labores ofensivos como defensivos, asi que será el principal foco de estudio de esta sección.

A pesar de que *Nmap* destaca como un perfecto ***escáner de puertos***, no hay que olvidar que es una herramienta altamente versátil capaz de darnos aún más que un simple escaneo.

Antes de leer esta nota, recomiendo altamente tener una noción básica acerca de capas de red, puertos y protocolos de transporte, pues obviaré algunos conceptos y términos.

### Escaneo de puertos

> La **idea básica** de un ***escaneo de puertos*** es determinar que puertos de un dispositivo están ==abiertos a la comunicación== y cuales no.

***¿Y porque nos interesa eso?*** Pues básicamente, queremos saber que ***servicios*** está ofreciendo dicho dispositivo o que maneras de ***interactuar*** con él poseemos.

Por ejemplo si el dispositivo tiene el puerto **80** abierto, por convención, podemos pensar que está ofreciendo un servicio *HTTP* como servidor, o dicho más simple, que esta levantando una página *web* en Internet o alguna otra red.

Sabiendo esto, sabemos que podemos interactuar con nuestro navegador por ejemplo, con el dispositivo para inspeccionar el contenido *web* y demás acciones.

#### Procedimiento técnico

> ***¿Y como hace este escaneo la herramienta?*** Para determinar el estado del puerto, *Nmap* intenta iniciar una sesión *TCP* con el objetivo mediante el típico *Three Way HandShake*.

Primero que nada, *Nmap* realiza una solicitud ICMP *ping* al objetivo designado, para confirmar que se encuentre activo y funcionando.

Una vez confirmada la actividad del objetivo, *Nmap* envía un paquete de red con la bandera *SYN* activa en el segmento *TCP*.

Esto se realiza con la intención de indicar al servidor que deseamos establecer una conexión con él, y esperamos que nos responda otro paquete con las banderas *SYN/ACK*.

Si sucede esto, *Nmap* envía un paquete con la bandera *ACK* para confirmar la conexión y a nosotros como usuarios, nos indica que el puerto está ***abierto***.

Por otra parte, si *Nmap* recibe un paquete con la bandera *RST* activa, nos indica que el puerto está ***cerrado*** y no desea establecer ninguna conexión.

Además, podría ser que *Nmap* no reciba ninguna respuesta por parte del objetivo, ni de confirmación ni de negación ni nada, entonces *Nmap* asume que la comunicación está interferida por un *Firewall* y nos indica que el puerto está ***filtrado***.

### Uso básico

Ahora que conocemos los fundamentos, podemos hablar sobre el uso de la herramienta, pero antes quiero advertir algo importante.

A pesar de que no es formalmente un crimen, **escanear sin permiso es percibido como una amenaza potencial**, pues este tipo de reconocimiento es parte de un ==ataque real==.

Por favor asegurate que el objetivo que selecciones para escanear sea seguro y/o permitido de hacerlo, o al menos que este consciente de tus actividades.
Incluso puedes usar otros ordenadores tuyos como objetivos, mquinas virtuales o tu propio modem de internet.

> Volviendo al tema, para realizar un escaneo simplemente debemos invocar `nmap` junto con el ***dirección IP*** o ***nombre de dominio*** del objetivo, pues *Nmap* puede resolverlo a dirección *IP* sin problema.

```bash
# -- Mi modem
nmap 192.168.90.1

# Starting Nmap 7.95 ( https://nmap.org ) at 2024-11-23 23:35 CST
# Nmap scan report for 192.168.90.1
# Host is up (0.017s latency).
# Not shown: 995 closed tcp ports (conn-refused)
# PORT     STATE    SERVICE
# 22/tcp   filtered ssh
# 23/tcp   open     telnet
# 53/tcp   open     domain
# 80/tcp   open     http
# 8022/tcp filtered oa-system
# 
# Nmap done: 1 IP address (1 host up) scanned in 1.35 seconds

# -- Página demo para escanear de Nmap
nmap scanme.nmap.org

# Starting Nmap 7.95 ( https://nmap.org ) at 2024-11-23 23:41 CST
# Nmap scan report for scanme.nmap.org (45.33.32.156)
# Host is up (0.24s latency).
# Other addresses for scanme.nmap.org (not scanned): 2600:3c01::f03c:91ff:fe18:bb2f
# Not shown: 994 closed tcp ports (conn-refused)
# PORT      STATE    SERVICE
# 22/tcp    open     ssh
# 25/tcp    filtered smtp
# 53/tcp    open     domain
# 80/tcp    open     http
# 9929/tcp  open     nping-echo
# 31337/tcp open     Elite
# 
# Nmap done: 1 IP address (1 host up) scanned in 46.88 seconds
```

También podemos indicar más de un *host*, ya sea separado por espacios, un rango de *hosts* o incluso un rango de *hosts* en formato *CIDR*.

```bash
# Más de 1 host
nmap 192.168.90.1 192.168.90.111 192.168.90.200 # Escanea 3 hosts

# Rango de hosts
nmap 192.168.90.1-5 # Escanea 5

# CIDR
nmap 192.168.90.0/24 # Escanea los 255 hosts de la red
```

Como podemos ver en los resultados, *Nmap* nos indica el puerto, el protocolo de transporte, el estado del puerto, el servicio corriendo. Además si indicamos la bandera `--reason` nos indicara una breve razón de como concluyo que estaba abierto o cerrado, aunque esto tambien se consigue ***incrementando la verbosidad***.

### Opciones recomendadas

> *Nmap* posee una infinidad de opciones, muchas de las que planeo cubir en notas subsecuentes, sin embargo hay una pequeña selección de ellas que considero útiles y básicas en la mayoría de los escenarios.

##### Versiones de servicio

Indicando la bandera `-sV` al comando, *Nmap* intentará averiguar las ==versiones de los servicios corriendo en el objetivo== y el sistema operativo del objetivo para informarnoslo en la salida.

```bash
nmap -sV scanme.nmap.org

# ...
# PORT      STATE    SERVICE    VERSION
# 22/tcp    open     ssh        OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.13 (Ubuntu Linux; protocol 2.0)
# 25/tcp    filtered smtp
# 53/tcp    open     domain     (generic dns response: NOTIMP)
# 80/tcp    open     http?
# 9929/tcp  open     nping-echo Nping echo
# 31337/tcp open     tcpwrapped
# ...
# Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

##### Indicando un rango de puertos

Por defecto, *Nmap* escanea únicamente los 1000 puertos más famosos y utilizados por servidores de todos los 65536 puertos disponibles.

Sin embargo, podemos indicarle un rango personalizado de puertos mediante la bandera `-p` y una de las siguientes formas de especificar los puertos deseados:

- `-p 100`: Se le indica el único puerto que deseamos escanear
- `-p 22,53,80,443`: Se le indican varios puertos separados por comas
- `-p 1-1000`: Se le indica un rango de puertos
- `-p 1-1000,2004,8080-8082,9000`: Rangos y/o puertos separados por comas
- `-p-`: Todos los **65536** puertos

##### Registrando el escaneo

Podemos registrar en un archivo los hallazgos del escaneo, de modo que los tengamos a la mano para posteriores consultas sin la necesidad de reinvocar este escaneo.

Existen varios formatos de registro, por lo general basta con el **formato normal** para escaneos pequeños, invocable con la bandera `-oN [archivo]`:

```bash
nmap -oN resultados.nmap -sV scanme.nmap.org
```

El **formato normal** consiste en guardar la información tal cual la vemos en la sálida estándar de la terminal, como en los ejemplos más arriba.

Sin embargo, para un análisis más profundo o enfocado tenemos más opciones de registro como:

- `-oX resultados.xml`: Para registrar los resultados en **formato XML**.
- `-oG resultados.gnmap`: Para registrar los resultados en **formato grepeable**, un formato redactado de tal forma que podemos usar el comando `grep` fácilmente para hallar la información deseada.
- `-oA resultados`: Genera 3 archivos distintos `resultados.nmap`, `resultados.xml` y `resultados.gnmap` con los resultados en formato normal, *XML* y *grepeable* respectivamente, es decir, todos los formatos

> Y una mención honorifica al formato meme *\$cr1pt k1dd13*, invocable con el comando `-oS` donde se registran los resultados de manera normal pero con algunas letras intercambiadas por simbolos parecidos, no olvides usar esta para verte más *hacker*.

##### Escaneo "sigiloso"

> *Nmap* ofrece varios tipos de escaneo que planeo profundizar más adelante, sin embargo, además del escaneo por defecto, hay uno de ellos que destaca sobre el resto.

Este es el el escaneo *SYN*, tambien conocido como escaneo medio abierto o "sigiloso", y podemos indicarlo con la bandera `-sS`.

Anteriormente hablamos sobre que el escaneo por defecto, cuyo nombre formal es ***escaneo TCP***, ejecuta un *Three Way HandShake* completo para confirmar que el puerto está abierto.

Sin embargo, podemos darnos cuenta que el puerto confirma su apertura desde que responde con un *SYN/ACK*, entonces en lugar de terminar satisfactoriamente el *Three Way Handshake*, el ***escaneo SYN*** opta por contestar a esto con una bandera *RST*, terminando prematuramente la conexión.

Este hecho hace que la conexión sea más rápida y *"no sea tomada en serio"* por los servidores, de modo que muchas veces pasaba inadvertida por bitácoras y demás sistemas preventivos que estaban a la caza de conexiones satisfactoriamente establecidas mediante el *Three Way Handshake* (de ahi que antes se le denominara sigiloso, aunque actualmente ya no lo es tanto).

Entonces, sin posponer más el comando, es el siguiente:

```bash
sudo nmap -sS scanme.nmap.org
```

Este escaneo requiere permisos elevados para su ejecución, pues crear paquetes crudos con la bandera *RST* no es una actividad precisamente cotidiana.

Sin embargo, dada su efectividad sobre el **escaneo TCP**, el **escaneo SYN** se realiza por defecto al ejecutar `nmap` con estos permisos elevados, por lo que no hace falta realmente indicar esta bandera si lo ejecutamos con `sudo`:

```bash
sudo nmap scanme.nmap.org
```

Si deseas profundizar en más opciones generales útiles de *Nmap* puedes continuar en [esta nota](MasNmap.md).

# Enlaces

[Enumeración de Hosts ->](Nmap-EscaneoHosts.md)